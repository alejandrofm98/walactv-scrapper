worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       /usr/local/openresty/nginx/conf/mime.types;
    default_type  application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /dev/stdout main;
    error_log  /dev/stderr warn;

    # CORS
    map $http_origin $cors_origin {
        default "";
        ~^https?://(localhost|.*\.walerike\.com)$ $http_origin;
    }

    server {
        listen 80;
        server_name _;

        location / {
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }

        location /ace/ {
            content_by_lua_block {
                local http = require "resty.http"
                local httpc = http.new()
                httpc:set_timeout(60000)

                local uri = ngx.var.request_uri
                local url = "http://acestream-arm:6878" .. uri
                local max_redirects = 10
                local redirect_count = 0

                ngx.log(ngx.WARN, "Initial request: ", url)

                while redirect_count < max_redirects do
                    local res, err = httpc:request_uri(url, {
                        method = ngx.req.get_method(),
                        headers = {
                            ["Host"] = "acestream.walerike.com",
                        },
                        keepalive_timeout = 60000,
                        keepalive_pool = 10
                    })

                    if not res then
                        ngx.log(ngx.ERR, "Request failed: ", err)
                        ngx.status = 502
                        ngx.say("Error connecting to Acestream: ", err)
                        return ngx.exit(502)
                    end

                    ngx.log(ngx.WARN, "Response status: ", res.status)

                    -- Si no es redirección, devolver el contenido
                    if res.status ~= 301 and res.status ~= 302 and res.status ~= 307 and res.status ~= 308 then
                        -- CORS headers
                        local origin = ngx.var.http_origin
                        if origin and (string.match(origin, "localhost") or string.match(origin, "walerike%.com")) then
                            ngx.header["Access-Control-Allow-Origin"] = origin
                            ngx.header["Access-Control-Allow-Credentials"] = "true"
                        end
                        ngx.header["Access-Control-Allow-Methods"] = "GET, POST, OPTIONS"
                        ngx.header["Access-Control-Allow-Headers"] = "*"
                        ngx.header["Access-Control-Expose-Headers"] = "Content-Length,Content-Range"

                        -- Copiar headers importantes
                        if res.headers["Content-Type"] then
                            ngx.header["Content-Type"] = res.headers["Content-Type"]
                        end
                        if res.headers["Content-Length"] then
                            ngx.header["Content-Length"] = res.headers["Content-Length"]
                        end

                        ngx.status = res.status
                        ngx.print(res.body)
                        return ngx.exit(res.status)
                    end

                    -- Obtener location de la redirección
                    local location = res.headers["Location"] or res.headers["location"]
                    if not location then
                        ngx.log(ngx.ERR, "Redirect without Location header")
                        ngx.status = 502
                        ngx.say("Invalid redirect")
                        return ngx.exit(502)
                    end

                    ngx.log(ngx.WARN, "Redirecting to: ", location)

                    -- Construir nueva URL
                    if string.sub(location, 1, 1) == "/" then
                        url = "http://acestream-arm:6878" .. location
                    elseif string.sub(location, 1, 4) == "http" then
                        -- Reemplazar dominio/puerto si es necesario
                        url = string.gsub(location, "http://[^/]+:6878", "http://acestream-arm:6878")
                        url = string.gsub(url, "http://acestream%.walerike%.com:6878", "http://acestream-arm:6878")
                        url = string.gsub(url, "http://acestream%.walerike%.com", "http://acestream-arm:6878")
                    else
                        url = location
                    end

                    redirect_count = redirect_count + 1
                end

                ngx.log(ngx.ERR, "Too many redirects (", max_redirects, ")")
                ngx.status = 508
                ngx.say("Too many redirects")
                return ngx.exit(508)
            }
        }
    }
}