# Stage 1: Build proxy completo con su propio Python
FROM python:3.11-alpine AS proxy-builder

WORKDIR /app

# Instalar dependencias de compilación necesarias
RUN apk add --no-cache \
    gcc \
    musl-dev \
    linux-headers \
    libffi-dev \
    openssl-dev

# Copiar requirements y instalar en un virtualenv
COPY docker/config/requirements.txt .
RUN python3 -m venv /venv && \
    /venv/bin/pip install --no-cache-dir --upgrade pip && \
    /venv/bin/pip install --no-cache-dir -r requirements.txt gunicorn

# Stage 2: Imagen final ARM64
FROM jopsis/acestream:arm64-v3.2.14-update

USER root

# Instalar solo las herramientas necesarias (NO python3 para evitar conflictos)
RUN apk add --no-cache \
    curl \
    jq \
    supervisor \
    netcat-openbsd \
    libgcc \
    libstdc++

# Copiar Python completo desde el builder con sus librerías
COPY --from=proxy-builder /usr/local/bin/python3.11 /usr/local/bin/python-proxy
COPY --from=proxy-builder /usr/local/lib/python3.11 /usr/local/lib/python3.11
COPY --from=proxy-builder /usr/local/lib/libpython3.11.so.1.0 /usr/local/lib/ 2>/dev/null || true
COPY --from=proxy-builder /venv /proxy/venv

# Crear enlace simbólico para el virtualenv
RUN ln -sf /usr/local/bin/python-proxy /proxy/venv/bin/python3.11

# Crear directorios necesarios
RUN mkdir -p /proxy /var/log/supervisor

# Copiar archivos del proyecto
WORKDIR /proxy

# Copiar el proxy desde scripts/
COPY scripts/acestream_proxy.py .

# Copiar requirements.txt (por referencia)
COPY docker/config/requirements.txt .

# Copiar scripts de inicialización para ARM64
COPY docker/scripts/acestream-init-arm64.sh /usr/local/bin/acestream-init.sh
COPY docker/scripts/start-all.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/acestream-init.sh /usr/local/bin/start-all.sh

# Copiar configuración de supervisord para ARM64
COPY docker/config/supervisord-arm64.conf /etc/supervisor/conf.d/supervisord.conf

EXPOSE 6878 3000

CMD ["/usr/local/bin/start-all.sh"]