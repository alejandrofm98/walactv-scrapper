# Stage 1: Build proxy standalone completo
FROM python:3.11-alpine AS proxy-builder

WORKDIR /app

# Instalar dependencias de compilación
RUN apk add --no-cache \
    gcc \
    musl-dev \
    linux-headers \
    libffi-dev \
    openssl-dev

# Copiar requirements y crear un ejecutable standalone
COPY docker/config/requirements.txt .
COPY scripts/acestream_proxy.py .

# Instalar dependencias globalmente en el builder
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt gunicorn

# Stage 2: Imagen final ARM64 - SIN Python adicional
FROM jopsis/acestream:arm64-v3.2.14-update

USER root

# Instalar SOLO herramientas básicas - NO PYTHON
RUN apk add --no-cache \
    curl \
    jq \
    supervisor \
    netcat-openbsd \
    libgcc \
    libstdc++ \
    && rm -rf /var/cache/apk/*

# Copiar TODO el árbol de Python desde el builder a una ubicación separada
COPY --from=proxy-builder /usr/local /opt/proxy-python

# Crear directorios
RUN mkdir -p /proxy /var/log/supervisor

WORKDIR /proxy

# Copiar el proxy
COPY scripts/acestream_proxy.py .
COPY docker/config/requirements.txt .

# Copiar scripts de inicialización
COPY docker/scripts/acestream-init-arm64.sh /usr/local/bin/acestream-init.sh
COPY docker/scripts/start-all.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/acestream-init.sh /usr/local/bin/start-all.sh

# Copiar configuración de supervisord
COPY docker/config/supervisord-arm64.conf /etc/supervisor/conf.d/supervisord.conf

EXPOSE 6878 3000

CMD ["/usr/local/bin/start-all.sh"]