# Stage 1: Build proxy completo con Python independiente
FROM python:3.11-alpine AS proxy-builder

WORKDIR /app

# Instalar dependencias de compilación necesarias
RUN apk add --no-cache \
    gcc \
    musl-dev \
    linux-headers \
    libffi-dev \
    openssl-dev

# Copiar requirements y instalar
COPY docker/config/requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt gunicorn

# Copiar el proxy
COPY scripts/acestream_proxy.py .

# Stage 2: Imagen final ARM64
FROM jopsis/acestream:arm64-v3.2.14-update

USER root

# Instalar herramientas necesarias y Python standalone
RUN apk add --no-cache \
    python3 \
    py3-pip \
    curl \
    jq \
    supervisor \
    netcat-openbsd && \
    # Remover el enlace de Python que conflictúa con Acestream
    rm -f /usr/bin/python /usr/bin/python3 || true

# Crear un wrapper para Python del proxy que use el de Alpine
RUN echo '#!/bin/sh' > /usr/local/bin/python-proxy && \
    echo 'exec /usr/bin/python3.* "$@"' >> /usr/local/bin/python-proxy && \
    chmod +x /usr/local/bin/python-proxy

# Instalar pip para Python de Alpine en un directorio específico
RUN /usr/bin/python3.* -m ensurepip --default-pip && \
    /usr/bin/python3.* -m pip install --no-cache-dir --upgrade pip

# Crear directorios necesarios
RUN mkdir -p /proxy /var/log/supervisor

# Copiar archivos del proyecto
WORKDIR /proxy

# Copiar el proxy y requirements desde el builder
COPY --from=proxy-builder /app/acestream_proxy.py .
COPY --from=proxy-builder /app/requirements.txt .

# Instalar dependencias usando Python de Alpine en ubicación separada
RUN /usr/bin/python3.* -m pip install --no-cache-dir \
    --target=/proxy/packages \
    -r requirements.txt gunicorn

# Copiar scripts de inicialización para ARM64
COPY docker/scripts/acestream-init-arm64.sh /usr/local/bin/acestream-init.sh
COPY docker/scripts/start-all.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/acestream-init.sh /usr/local/bin/start-all.sh

# Copiar configuración de supervisord para ARM64
COPY docker/config/supervisord-arm64.conf /etc/supervisor/conf.d/supervisord.conf

# Configurar PYTHONPATH para el proxy
ENV PYTHONPATH=/proxy/packages

EXPOSE 6878 3000

CMD ["/usr/local/bin/start-all.sh"]