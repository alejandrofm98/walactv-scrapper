# ================================
# Stage 1: Build proxy standalone
# ================================
FROM python:3.11-alpine AS proxy-builder

WORKDIR /app

RUN apk add --no-cache gcc musl-dev linux-headers libffi-dev openssl-dev

COPY docker/config/requirements.txt .
COPY scripts/acestream_proxy.py .

RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt gunicorn

# ================================
# Stage 2: Imagen final ARM64
# ================================
FROM jopsis/acestream:arm64-v3.2.14-update

USER root

# SOLO herramientas básicas - NO Python
RUN apk add --no-cache curl jq netcat-openbsd supervisor

# Copiar Python del proxy a ubicación aislada
RUN mkdir -p /proxy-env

COPY --from=proxy-builder /usr/local /proxy-env/python

# Crear directorios
RUN mkdir -p /proxy/logs /var/log/supervisor

WORKDIR /proxy

# Copiar proxy
COPY scripts/acestream_proxy.py .
COPY docker/config/requirements.txt .

# TUS scripts con TUS nombres
COPY docker/scripts/acestream-init-arm64.sh /usr/local/bin/acestream-init-arm64.sh
COPY docker/scripts/start-all-arm64.sh /usr/local/bin/start-all-arm64.sh
RUN chmod +x /usr/local/bin/acestream-init-arm64.sh /usr/local/bin/start-all-arm64.sh

# TU configuración de supervisord
COPY docker/config/supervisord-arm64.conf /etc/supervisor/conf.d/supervisord.conf

EXPOSE 6878 3000

# Usar TU script de inicio
CMD ["/usr/local/bin/start-all-arm64.sh"]