# ================================
# Imagen final ARM64 - Estrategia simplificada
# ================================
FROM jopsis/acestream:arm64-v3.2.14-update

USER root

# Instalar Python3 de Alpine y herramientas
RUN apk add --no-cache python3 py3-pip curl jq netcat-openbsd && \
    rm -rf /var/cache/apk/*

# CRÍTICO: Limpiar variables de Acestream antes de usar Python de Alpine
ENV PYTHONHOME="" \
    PYTHONPATH="" \
    ANDROID_ROOT="" \
    ANDROID_DATA="" \
    LD_LIBRARY_PATH=""

# Ahora crear virtualenv (con variables limpiadas)
RUN python3 -m venv /opt/proxy-venv

# Restaurar variables de Acestream para el runtime
ENV PYTHONHOME="/acestream/python" \
    PYTHONPATH="/acestream/python/lib/stdlib:/acestream/python/lib/modules:/acestream/data:/acestream/modules.zip:/acestream/eggs-unpacked:/acestream/lib" \
    ANDROID_ROOT="/system" \
    ANDROID_DATA="/data" \
    LD_LIBRARY_PATH="/system/lib64:/system/lib:/acestream/python/lib"

# Instalar dependencias del proxy en el virtualenv
COPY docker/config/requirements.txt /tmp/requirements.txt
RUN /opt/proxy-venv/bin/pip install --no-cache-dir --upgrade pip && \
    /opt/proxy-venv/bin/pip install --no-cache-dir -r /tmp/requirements.txt gunicorn && \
    rm /tmp/requirements.txt

# Crear directorios
RUN mkdir -p /proxy/logs

WORKDIR /proxy

# Copiar proxy
COPY scripts/acestream_proxy.py .
COPY docker/config/requirements.txt .

# Scripts
COPY docker/scripts/acestream-init-arm64.sh /usr/local/bin/acestream-init-arm64.sh
COPY docker/scripts/start-all-arm64.sh /usr/local/bin/start-all-arm64.sh
RUN chmod +x /usr/local/bin/acestream-init-arm64.sh /usr/local/bin/start-all-arm64.sh

# Verificar instalación
RUN echo "=== Verificando instalación ===" && \
    ls -la /opt/proxy-venv/bin/gunicorn && \
    /opt/proxy-venv/bin/python3 --version && \
    echo "=== Instalación correcta ==="

EXPOSE 6878 3000

CMD ["/usr/local/bin/start-all-arm64.sh"]