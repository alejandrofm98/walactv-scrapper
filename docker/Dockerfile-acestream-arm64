# ================================
# Stage 1: Build proxy standalone
# ================================
FROM python:3.11-alpine AS proxy-builder

WORKDIR /app

RUN apk add --no-cache gcc musl-dev linux-headers libffi-dev openssl-dev

COPY docker/config/requirements.txt .
COPY scripts/acestream_proxy.py .

RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt gunicorn

# ================================
# Stage 2: Imagen final ARM64
# NO TOCAR - La imagen ya tiene todo configurado
# ================================
FROM jopsis/acestream:arm64-v3.2.14-update

USER root

# SOLO instalar herramientas básicas - NO Python
RUN apk add --no-cache curl jq netcat-openbsd supervisor

# Copiar SOLO el Python del proxy a una ubicación completamente aislada
RUN mkdir -p /proxy-env

COPY --from=proxy-builder /usr/local /proxy-env/python

# Crear directorio para el proxy
RUN mkdir -p /proxy/logs /var/log/supervisor

WORKDIR /proxy

# Copiar proxy
COPY scripts/acestream_proxy.py .
COPY docker/config/requirements.txt .

# Scripts de inicio
COPY docker/scripts/start-acestream.sh /usr/local/bin/start-acestream.sh
COPY docker/scripts/start-proxy.sh /usr/local/bin/start-proxy.sh
COPY docker/scripts/acestream-login.sh /usr/local/bin/acestream-login.sh
RUN chmod +x /usr/local/bin/start-*.sh /usr/local/bin/acestream-login.sh

# Configuración de supervisord
COPY docker/config/supervisord-arm64.conf /etc/supervisor/conf.d/supervisord.conf

EXPOSE 6878 3000

# Usar supervisord como proceso principal
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]