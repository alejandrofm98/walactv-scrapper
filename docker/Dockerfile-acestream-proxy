FROM python:3.11-alpine

WORKDIR /app

# Instalar dependencias
RUN apk add --no-cache gcc musl-dev linux-headers libffi-dev openssl-dev

# Copiar requirements
COPY docker/config/requirements.txt .

# Instalar paquetes Python + gevent para workers as√≠ncronos
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt gunicorn gevent

# Copiar el proxy
COPY scripts/acestream_proxy.py .

# Variables de entorno por defecto
ENV ACESTREAM_HOST=acestream-engine \
    ACESTREAM_PORT=6878

EXPOSE 3000

# Workers gevent con timeout infinito para streaming
CMD ["gunicorn", \
     "--workers", "4", \
     "--worker-class", "gevent", \
     "--worker-connections", "1000", \
     "--timeout", "0", \
     "--bind", "0.0.0.0:3000", \
     "--access-logfile", "-", \
     "--error-logfile", "-", \
     "--log-level", "info", \
     "acestream_proxy:app"]