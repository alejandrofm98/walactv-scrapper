services:
  acestream:
    image: jopsis/acestream:arm32-v3.2.14-update
    container_name: acestream
    restart: unless-stopped
    hostname: acestream
    tmpfs:
      - /dev/shm:size=4g
      - /root/.ACEStream:size=2g
      - /tmp:size=1g
    environment:
      TZ: Europe/Madrid
      ALLOW_REMOTE_ACCESS: "yes"
      CACHE_SIZE: "1024"
      DISK_CACHE_SIZE: "1536"
      HTTP_HOST: "acestream.walerike.com"
      HTTP_PORT: "6878"
    volumes:
      - acestream-config:/acestream.engine
    networks:
      - dokploy-network
    # IMPORTANTE: Exponer el puerto 6878
    ports:
      - "6878:6878"
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"

      # HTTP -> HTTPS redirect
      - "traefik.http.middlewares.acestream-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.acestream-redirect.redirectscheme.permanent=true"

      # HTTP Router
      - "traefik.http.routers.acestream-http.rule=Host(`acestream.walerike.com`)"
      - "traefik.http.routers.acestream-http.entrypoints=web"
      - "traefik.http.routers.acestream-http.middlewares=acestream-redirect"
      - "traefik.http.routers.acestream-http.service=acestream-svc"

      # HTTPS Router
      - "traefik.http.routers.acestream-https.rule=Host(`acestream.walerike.com`)"
      - "traefik.http.routers.acestream-https.entrypoints=websecure"
      - "traefik.http.routers.acestream-https.tls=true"
      - "traefik.http.routers.acestream-https.tls.certresolver=letsencrypt"
      - "traefik.http.routers.acestream-https.service=acestream-svc"

      # Service
      - "traefik.http.services.acestream-svc.loadbalancer.server.port=6878"
      - "traefik.http.services.acestream-svc.loadbalancer.passhostheader=true"


  acestream-cleaner:
    image: alpine:latest
    container_name: acestream-cleaner
    restart: unless-stopped
    depends_on:
      - acestream
    environment:
      TZ: Europe/Madrid
      CLEAN_INTERVAL: "1800"
      DISK_THRESHOLD: "80"
      MAX_FILE_AGE: "30"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: >
      sh -c "
        apk add --no-cache docker-cli bash &&
        echo 'üßπ AceStream Auto-Cleaner iniciado' &&
        
        while true; do
          echo '[$(date)] üîç Iniciando limpieza...' &&
          
          if ! docker ps --format '{{.Names}}' | grep -q '^acestream$$'; then
            echo '[$(date)] ‚ö†Ô∏è  Contenedor no est√° corriendo' &&
            sleep 60 &&
            continue
          fi &&
          
          echo '[$(date)] üóëÔ∏è  Limpiando archivos antiguos...' &&
          docker exec acestream sh -c '
            find /root/.ACEStream -type f -mmin +30 -delete 2>/dev/null || true
            find /tmp -type f -mmin +30 -delete 2>/dev/null || true
            find /root/.ACEStream -name \"*.log\" -mtime +1 -delete 2>/dev/null || true
          ' 2>/dev/null &&
          
          DISK_USAGE=$$(docker exec acestream sh -c \"df /root/.ACEStream | tail -1 | awk '{print \$$5}' | sed 's/%//'\" 2>/dev/null || echo 0) &&
          echo '[$(date)] üìä Uso de disco: '$$DISK_USAGE'%' &&
          
          if [ \"$$DISK_USAGE\" -gt \"80\" ]; then
            echo '[$(date)] ‚ö†Ô∏è  Uso alto - Limpieza agresiva' &&
            docker exec acestream sh -c '
              find /root/.ACEStream -type f ! -name \"*.conf\" ! -name \"*.db\" -delete 2>/dev/null || true
              rm -rf /tmp/* 2>/dev/null || true
              sync
            ' 2>/dev/null &&
            
            NEW_USAGE=$$(docker exec acestream sh -c \"df /root/.ACEStream | tail -1 | awk '{print \$$5}' | sed 's/%//'\" 2>/dev/null || echo 0) &&
            echo '[$(date)] üìä Nuevo uso: '$$NEW_USAGE'%' &&
            
            if [ \"$$NEW_USAGE\" -gt \"90\" ]; then
              echo '[$(date)] üîÑ Reiniciando contenedor...' &&
              docker restart acestream &&
              sleep 15
            fi
          fi &&
          
          docker exec acestream sh -c '
            find /root/.ACEStream -type d -name \"session_*\" -mmin +60 -exec rm -rf {} + 2>/dev/null || true
          ' 2>/dev/null &&
          
          FILE_COUNT=$$(docker exec acestream sh -c 'find /root/.ACEStream -type f 2>/dev/null | wc -l' 2>/dev/null || echo 0) &&
          echo '[$(date)] üìÅ Archivos en cache: '$$FILE_COUNT &&
          echo '[$(date)] ‚úÖ Limpieza completada' &&
          
          sleep $${CLEAN_INTERVAL}
        done
      "
    networks:
      - dokploy-network

  acestream-init:
    image: alpine:latest
    container_name: acestream-init
    depends_on:
      - acestream
    environment:
      EMAIL: ${ACESTREAM_EMAIL}
      PASSWORD: ${ACESTREAM_PASSWORD}
    command: >
      sh -c "
      apk add --no-cache curl jq &&
      echo 'üîç Variables:' &&
      echo \"EMAIL: $$EMAIL\" &&
      echo \"PASSWORD: ***\" &&
      echo '‚è≥ Esperando 30 segundos...' &&
      sleep 30 &&
      echo 'üîë Obteniendo token...' &&
      TOKEN='' &&
      RETRIES=0 &&
      until [ -n \"$$TOKEN\" ] && [ \"$$TOKEN\" != 'null' ]; do
        if [ $$RETRIES -ge 30 ]; then
          echo '‚ùå No se pudo obtener token';
          exit 1;
        fi;
        TOKEN=$$(curl -s 'http://acestream:6878/server/api?api_version=3&method=get_api_access_token' | jq -r '.result.token' 2>/dev/null) || true;
        echo \"Intento $$((RETRIES+1)): TOKEN=$$TOKEN\";
        [ -n \"$$TOKEN\" ] && [ \"$$TOKEN\" != 'null' ] || sleep 3;
        RETRIES=$$((RETRIES+1));
      done &&
      echo '‚úÖ Token obtenido: '$$TOKEN &&
      echo 'üîê Login (1/2)...' &&
      RESP=$$(curl -s \"http://acestream:6878/server/api?api_version=3&method=sign_in&token=$$TOKEN&password=$$PASSWORD&email=$$EMAIL\") &&
      echo \"Respuesta login:\" &&
      echo $$RESP | jq '.' &&
      sleep 2 &&
      echo 'üîç Verificando (2/2)...' &&
      curl -s \"http://acestream:6878/server/api?api_version=3&method=get_user_info&token=$$TOKEN\" | jq '.' &&
      echo '‚ú® Completado'
      "
    networks:
      - dokploy-network
    restart: "no"

volumes:
  acestream-config:

networks:
  dokploy-network:
    external: true
  aceserver:
    name: aceserver
    driver: bridge