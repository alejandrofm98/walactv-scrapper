services:
  # ============================================
  # 1. AceStream Engine (imagen según arquitectura)
  # ============================================
  acestream:
    image: ${ACESTREAM_IMAGE:-jopsis/acestream:arm64-v3.2.14-update}
    container_name: acestream
    restart: unless-stopped
    hostname: acestream
    environment:
      TZ: Europe/Madrid
      CACHE_SIZE: ${CACHE_SIZE:-1024}
    tmpfs:
      - /dev/shm:size=2g
      - /tmp:size=512m
    volumes:
      - acestream-cache:/root/.ACEStream
    dns:
      - 8.8.8.8
      - 8.8.4.4
    networks:
      - acestream-network
    ports:
      - "6878:6878"
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # ============================================
  # 2. AceStream Init (login/autenticación)
  # ============================================
  acestream-init:
    build:
      context: ..
      dockerfile: docker/Dockerfile-acestream-init
    container_name: acestream-init
    restart: "no"
    environment:
      ACESTREAM_EMAIL: ${ACESTREAM_EMAIL}
      ACESTREAM_PASSWORD: ${ACESTREAM_PASSWORD}
      ACESTREAM_HOST: acestream
      ACESTREAM_PORT: 6878
    networks:
      - acestream-network
    depends_on:
      - acestream

  # ============================================
  # 3. Proxy (Flask + Gunicorn)
  # ============================================
  acestream-proxy:
    build:
      context: ..
      dockerfile: docker/Dockerfile-acestream-proxy
    container_name: acestream-proxy
    restart: unless-stopped
    environment:
      ACESTREAM_HOST: acestream
      ACESTREAM_PORT: 6878
    networks:
      - acestream-network
      - dokploy-network
    depends_on:
      - acestream
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      # HTTPS Router
      - "traefik.http.routers.acestream-https.rule=Host(`acestream.walerike.com`)"
      - "traefik.http.routers.acestream-https.entrypoints=websecure"
      - "traefik.http.routers.acestream-https.tls=true"
      - "traefik.http.routers.acestream-https.tls.certresolver=letsencrypt"
      - "traefik.http.routers.acestream-https.service=acestream-proxy-svc"
      # HTTP Router
      - "traefik.http.routers.acestream-http.rule=Host(`acestream.walerike.com`)"
      - "traefik.http.routers.acestream-http.entrypoints=web"
      - "traefik.http.routers.acestream-http.service=acestream-proxy-svc"
      # Service
      - "traefik.http.services.acestream-proxy-svc.loadbalancer.server.port=3000"

  # ============================================
  # 4. AceStream Cleaner (limpieza automática)
  # ============================================
  acestream-cleaner:
    image: alpine:latest
    container_name: acestream-cleaner
    restart: unless-stopped
    volumes:
      - acestream-cache:/cache
      - ./scripts/cleaner.sh:/cleaner.sh:ro
    environment:
      TZ: Europe/Madrid
      # Tiempo en horas entre limpiezas (default: 6 horas)
      CLEANUP_INTERVAL: ${CLEANUP_INTERVAL:-6}
      # Edad máxima de archivos en días (default: 2 días)
      MAX_AGE_DAYS: ${MAX_AGE_DAYS:-2}
      # Tamaño máximo de caché en MB (default: 5GB = 5120MB)
      MAX_CACHE_SIZE_MB: ${MAX_CACHE_SIZE_MB:-5120}
    command: sh /cleaner.sh
    networks:
      - acestream-network

networks:
  acestream-network:
    driver: bridge
  dokploy-network:
    external: true

volumes:
  acestream-cache:
    driver: local