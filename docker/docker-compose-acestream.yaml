version: '3.8'

services:
  acestream:
    image: jopsis/acestream:x64
    container_name: acestream
    platform: linux/amd64
    restart: unless-stopped
    hostname: acestream
    tmpfs:
      - /dev/shm:size=2g,mode=1777
    ports:
      - "6878:6878"
    environment:
      TZ: Europe/Madrid
      ALLOW_REMOTE_ACCESS: "yes"
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
    volumes:
      - acestream-config:/acestream.engine
    networks:
      - dokploy-network  # Añadir también a la red de dokploy
      - acestream-net

  acestream-proxy:
    build:
      context: .
      dockerfile: Dockerfile-acestream  # Asegúrate que está en el contexto correcto
    container_name: acestream-proxy
    restart: unless-stopped
    ports:
      - "8000:8000"  # AÑADIR ESTO para acceso directo si es necesario
    depends_on:
      - acestream
    environment:
      ACESTREAM_HOST: "acestream"  # Nombre del servicio, no localhost
      ACESTREAM_PORT: "6878"
    dns:
      - 8.8.8.8
      - 8.8.4.4
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.acestream-http.rule=Host(`acestream.walerike.com`)"
      - "traefik.http.routers.acestream-http.entrypoints=web"
      - "traefik.http.routers.acestream-http.middlewares=acestream-redirect"
      - "traefik.http.middlewares.acestream-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.acestream-secure.rule=Host(`acestream.walerike.com`)"
      - "traefik.http.routers.acestream-secure.entrypoints=websecure"
      - "traefik.http.routers.acestream-secure.tls.certresolver=letsencrypt"
      - "traefik.http.services.acestream-secure.loadbalancer.server.port=8000"
    networks:
      - dokploy-network
      - acestream-net  # Añadir también a la red de acestream para comunicación interna

volumes:
  acestream-config:

networks:
  dokploy-network:
    external: true

  acestream-net:
    driver: bridge