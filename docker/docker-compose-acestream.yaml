services:
  acestream:
    image: jopsis/acestream:arm64-v3.2.14-update
    container_name: acestream
    restart: unless-stopped
    hostname: acestream
    tmpfs:
      - /dev/shm:size=2g,mode=1777
    ports:
      - "6878:6878"
    environment:
      TZ: Europe/Madrid
      ALLOW_REMOTE_ACCESS: "yes"
    volumes:
      - acestream-config:/acestream.engine
    networks:
      - dokploy-network
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -sf http://localhost:6878/server/api?api_version=3&method=get_api_access_token | grep -q token"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 30s

  acestream-init:
    image: alpine:latest
    container_name: acestream-init
    depends_on:
      acestream:
        condition: service_healthy
    environment:
      EMAIL: ${ACESTREAM_EMAIL}
      PASSWORD: ${ACESTREAM_PASSWORD}
    command: >
      sh -c "
      apk add --no-cache curl jq &&
      echo '‚è≥ Esperando 30 segundos...' &&
      sleep 30 &&
      echo 'üîë Obteniendo token...' &&
      TOKEN='' &&
      until [ -n \"$TOKEN\" ] && [ \"$TOKEN\" != 'null' ]; do
        TOKEN=$(curl -s 'http://acestream:6878/server/api?api_version=3&method=get_api_access_token' | jq -r '.result.token' 2>/dev/null) || true;
        echo \"TOKEN=$TOKEN\";
        [ -n \"$TOKEN\" ] && [ \"$TOKEN\" != 'null' ] || sleep 2;
      done &&
      echo '‚úÖ Token: '$TOKEN &&
      echo 'üîê Login (1/2)...' &&
      RESP=$(curl -s \"http://acestream:6878/server/api?api_version=3&method=sign_in&token=$TOKEN&password=$PASSWORD&email=$EMAIL\") &&
      echo $RESP | jq '.' &&
      sleep 2 &&
      echo 'üîç Verificando (2/2)...' &&
      curl -s \"http://acestream:6878/server/api?api_version=3&method=get_user_info&token=$TOKEN\" | jq '.' &&
      echo '‚ú® Completado'
      "
    networks:
      - dokploy-network
    restart: "no"

  acestream-proxy:
    build:
      context: ..
      dockerfile: docker/Dockerfile-acestream
    container_name: acestream-proxy
    restart: unless-stopped
    command: ["gunicorn", "-w", "4", "-k", "gevent", "--worker-connections", "1000", "-b", "0.0.0.0:8000", "--timeout", "300", "scripts.acestream_proxy:app"]
    depends_on:
      acestream:
        condition: service_healthy
    dns:
      - 8.8.8.8
      - 8.8.4.4
    ports:
      - "8000:8000"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      - "traefik.http.routers.acestream-http.rule=Host(`acestream.walerike.com`)"
      - "traefik.http.routers.acestream-http.entrypoints=web"
      - "traefik.http.routers.acestream-http.middlewares=redirect-to-https"
      - "traefik.http.routers.acestream-http.service=acestream-proxy"
      - "traefik.http.routers.acestream-https.rule=Host(`acestream.walerike.com`)"
      - "traefik.http.routers.acestream-https.entrypoints=websecure"
      - "traefik.http.routers.acestream-https.tls=true"
      - "traefik.http.routers.acestream-https.tls.certresolver=letsencrypt"
      - "traefik.http.routers.acestream-https.service=acestream-proxy"
      - "traefik.http.services.acestream-proxy.loadbalancer.server.port=8000"
    networks:
      - dokploy-network

volumes:
  acestream-config:

networks:
  dokploy-network:
    external: true